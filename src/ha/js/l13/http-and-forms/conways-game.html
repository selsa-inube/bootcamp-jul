<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      canvas {
        background-color: gray;
      }
    </style>
  </head>
  <body>
    <canvas id="game" width="500px" height="300px"></canvas>
    <button id="next">Next generation</button>
    <script>
      const GridModule = (() => {
        let grid = [];
        const game = document.getElementById("game");
        const makeGrid = game.getContext("2d");
        const cellSize = 20;
        const width = game.width;
        const height = game.height;

        function createGrid() {
          grid = Array.from({ length: height / cellSize }, () =>
            Array.from({ length: width / cellSize }, () =>
              Math.floor(Math.random() * 2),
            ),
          );
          GridModule.drawGrid();
        }
        function startGame() {
          GridModule.createGrid();
          return "game create";
        }
        function getGrid() {
          return grid;
        }

        function updateCell(x, y) {
          if (grid[y] && grid[y][x] !== undefined) {
            grid[y][x] = grid[y][x] === 1 ? 0 : 1;
          }
        }
        function calculateX(x) {
          let posittionX = Math.floor(x / cellSize);
          return posittionX;
        }
        function calculateY(y) {
          let postittionY = Math.floor(y / cellSize);
          return postittionY;
        }
        function drawGrid() {
          makeGrid.strokeStyle = "white";
          makeGrid.lineWidth = "1";

          for (let y = 0; y < grid.length; y++) {
            for (let x = 0; x < grid[y].length; x++) {
              makeGrid.fillStyle = grid[y][x] === 1 ? "red" : "gray";
              makeGrid.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
            }
          }
          for (let x = 0; x <= width; x += cellSize) {
            makeGrid.beginPath();
            makeGrid.moveTo(x, 0);
            makeGrid.lineTo(x, height);
            makeGrid.stroke();
          }

          for (let y = 0; y <= height; y += cellSize) {
            makeGrid.beginPath();
            makeGrid.moveTo(0, y);
            makeGrid.lineTo(width, y);
            makeGrid.stroke();
          }
        }
        function countLiveNeighbors(x, y) {
          let liveNeighbors = 0;

          for (let dy = -1; dy <= 1; dy++) {
            for (let dx = -1; dx <= 1; dx++) {
              if (dy === 0 && dx === 0) continue;

              const neighborX = x + dx;
              const neighborY = y + dy;
              if (
                neighborX >= 0 &&
                neighborX < grid[0].length &&
                neighborY >= 0 &&
                neighborY < grid.length
              ) {
                if (grid[neighborY][neighborX] === 1) {
                  liveNeighbors++;
                }
              }
            }
          }

          return liveNeighbors;
        }

        function ruleOne(liveNeighbors, x, y, newGrid) {
          if (grid[y][x] === 1 && (liveNeighbors < 2 || liveNeighbors > 3)) {
            newGrid[y][x] = 0;
          }
        }

        function ruleTwo(liveNeighbors, x, y, newGrid) {
          if (
            grid[y][x] === 1 &&
            (liveNeighbors === 2 || liveNeighbors === 3)
          ) {
            newGrid[y][x] = 1;
          }
        }

        function ruleThree(liveNeighbors, x, y, newGrid) {
          if (grid[y][x] === 0 && liveNeighbors === 3) {
            newGrid[y][x] = 1;
          }
        }

        function rules() {
          let newGrid = grid.map((row) => row.slice());

          for (let y = 0; y < grid.length; y++) {
            for (let x = 0; x < grid[y].length; x++) {
              const liveNeighbors = countLiveNeighbors(x, y);
              ruleOne(liveNeighbors, x, y, newGrid);
              ruleTwo(liveNeighbors, x, y, newGrid);
              ruleThree(liveNeighbors, x, y, newGrid);
            }
          }

          grid = newGrid;
        }

        return {
          createGrid,
          getGrid,
          updateCell,
          calculateX,
          calculateY,
          startGame,
          drawGrid,
          rules,
        };
      })();
      GridModule.startGame();

      game.addEventListener("click", (event) => {
        let rect = game.getBoundingClientRect();
        let x = event.clientX - rect.left;
        let y = event.clientY - rect.top;
        GridModule.updateCell(
          GridModule.calculateX(x),
          GridModule.calculateY(y),
        );
        GridModule.drawGrid();
        console.log(GridModule.getGrid());
      });

      next.addEventListener("click", () => {
        console.log("Next generation");
        GridModule.rules();

        GridModule.drawGrid();
      });
    </script>
  </body>
</html>
